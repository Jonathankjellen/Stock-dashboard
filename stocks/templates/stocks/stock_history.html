<!-- templates/stocks/stock_history.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stock History for {{ symbol }}</title>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>
    <h1>Stock History for {{ symbol }}</h1>
    <!-- <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Close</th>
                <th>Volume</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in stock_history %}
                <tr>
                    <td>{{ entry.date }}</td>
                    <td>{{ entry.open_price }}</td>
                    <td>{{ entry.high_price }}</td>
                    <td>{{ entry.low_price }}</td>
                    <td>{{ entry.close_price }}</td>
                    <td>{{ entry.volume }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table> -->
    <div id="chartdiv" style="width: 100%; height: 500px;"></div>
    <!-- <script type="application/json" id="stock-data">{{ stock_history|escapejs }}</script> -->
    <script id="stock-data" type="application/json">
        {{ stock_history|safe }}
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var stockData = document.getElementById('stock-data').textContent
            // Replace single-quoted values with double-quoted values
            stockData = stockData.replace(/([{,]\s*)'([^']+)'\s*:/g, '$1"$2":');
            stockData = stockData.replace(/:\s*'([^']+)'/g, ': "$1"');
            stockData = JSON.parse((stockData))
            
            // Need the following code, dont know why
            let indexedStockData = {};
            stockData.forEach((item, index) => {
                indexedStockData[index] = item;
            });

            var root = am5.Root.new("chartdiv");

            // Set themes
            root.setThemes([
                am5themes_Animated.new(root)
            ]);

            // Create chart
            var chart = root.container.children.push(am5xy.XYChart.new(root, {
                layout: root.verticalLayout,
                panX: true,
                panY: true,
                wheelX: "panX",
                wheelY: "zoomX",
                pinchZoomX: true
            }));

            var xRenderer = am5xy.AxisRendererX.new(root, {
                pan: "zoom",
                minorGridEnabled: true
            });
            xRenderer.labels.template.setAll({
                minPosition: 0.01,
                maxPosition: 0.99
            });

            var xAxis = chart.xAxes.push(am5xy.GaplessDateAxis.new(root, {
                baseInterval: { timeUnit: "day", count: 1 },
                renderer: xRenderer,
                tooltip: am5.Tooltip.new(root, {})
            }));

            // var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
            //     renderer: am5xy.AxisRendererY.new(root, {})
            // }));

            var yAxisRenderer = am5xy.AxisRendererY.new(root, {
                pan: "zoom"
            });
            yAxisRenderer.labels.template.setAll({
                centerY: am5.percent(100),
                maxPosition: 0.98
            });
            var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
                renderer: yAxisRenderer,
                height: am5.percent(70)
            }));
            yAxis.axisHeader.children.push(am5.Label.new(root, {
                text: "Value",
                fontWeight: "bold",
                paddingBottom: 5,
                paddingTop: 5
            }));

            var color = root.interfaceColors.get("background");
            var candleSeries = chart.series.push(
                am5xy.CandlestickSeries.new(root, {
                    fill: color,
                    clustered: false,
                    calculateAggregates: true,
                    stroke: color,
                    name: '{{ ticker }}',
                    xAxis: xAxis,
                    yAxis: yAxis,
                    valueYField: "close",
                    openValueYField: "open",
                    lowValueYField: "low",
                    highValueYField: "high",
                    valueXField: "date",
                    lowValueYGrouped: "low",
                    highValueYGrouped: "high",
                    openValueYGrouped: "open",
                    valueYGrouped: "close",
                    legendValueText: "open: {openValueY} low: {lowValueY} high: {highValueY} close: {valueY}",
                    legendRangeValueText: "{valueYClose}"
                })
                );

            // var blockSeries = chart.series.push( 
            //     am5xy.LineSeries.new(root, { 
            //         name: "Series", 
            //         xAxis: xAxis, 
            //         yAxis: yAxis, 
            //         valueYField: "close", 
            //         valueXField: "date",
            //         tooltip: am5.Tooltip.new(root, {labelText: "{valueY}"})
            //     }) 
            // );
            // var blockSeries = chart.series.push( 
            //     am5xy.ColumnSeries.new(root, { 
            //         name: "Series", 
            //         xAxis: xAxis, 
            //         yAxis: yAxis, 
            //         valueYField: "close", 
            //         valueXField: "date",
            //         tooltip: am5.Tooltip.new(root, {labelText: "{valueY}"})
            //     }) 
            // );
            candleSeries.data.processor = am5.DataProcessor.new(root, {
                dateFields: ["date"],
                dateFormat: "yyyy-MM-dd"
            });
            candleSeries.data.setAll(stockData);

            // Add scrollbar
            // chart.set("scrollbarX", am5.Scrollbar.new(root, {
            //     orientation: "horizontal"
            // }));
            chart.set("cursor", am5xy.XYCursor.new(root, {}));

            
            
            // xAxis.data.setAll(data);

            // Set data
            // series.data.setAll(stockData);
            // console.log(series)
            // Make stuff animate on load
            chart.appear(1000, 100);
        });
    </script>
    <a href="{% url 'stock_list' %}">Back to stock list</a>
</body>
</html>